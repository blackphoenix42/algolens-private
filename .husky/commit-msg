#!/bin/sh
set -e

MSG_FILE="$1"

# Allow merges/reverts/changeset releases
if grep -qiE '^(Merge|Revert|Release|chore\(release\))' "$MSG_FILE"; then
  exit 0
fi

# Prefer commitlint if available
if command -v npx >/dev/null 2>&1 && npx --no-install commitlint --help >/dev/null 2>&1; then
  npx --no-install commitlint --edit "$MSG_FILE"
  exit $?
fi

# Fallback: basic Conventional Commits check: type(scope?): subject
if ! grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9\-.,/]+\))?: .+' "$MSG_FILE"; then
  echo "â›” Commit message must follow Conventional Commits, e.g.:"
  echo "   feat(ui): add dark mode toggle"
  echo "   fix(engine): handle empty dataset"
  exit 1
fi
