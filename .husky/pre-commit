#!/bin/sh
set -e

echo "ðŸ”Ž Pre-commit checksâ€¦"

# Prefer lint-staged if available
if command -v npx >/dev/null 2>&1 && npx --no-install lint-staged --version >/dev/null 2>&1; then
  npx --no-install lint-staged
else
  # Fallback: Prettier + ESLint over staged files only
  STAGED_NUL=$(git diff --cached --name-only --diff-filter=ACMR -z)
  if [ -n "$STAGED_NUL" ]; then
    # Prettier (all staged)
    if npx --no-install prettier --version >/dev/null 2>&1; then
      echo "â†’ Prettier (write)"
      printf "%s" "$STAGED_NUL" | xargs -0 npx --no-install prettier --write --log-level warn || true
      git add -A
    fi
    # ESLint (only JS/TS)
    if npx --no-install eslint --version >/dev/null 2>&1; then
      echo "â†’ ESLint (fix)"
      FILES_JS_TS=$(printf "%s" "$STAGED_NUL" | tr '\0' '\n' | grep -E '\.(ts|tsx|js|jsx)$' || true)
      if [ -n "$FILES_JS_TS" ]; then
        echo "$FILES_JS_TS" | xargs npx --no-install eslint --fix --max-warnings=0
        git add $FILES_JS_TS || true
      fi
    fi
  fi
fi

# Block focused/skipped tests
FOCUSED=$(git diff --cached -U0 | grep -E '^\+.*\b(it|test|describe)\.only\(|^\+.*\.(only|skip)\(' || true)
if [ -n "$FOCUSED" ]; then
  echo "â›” Found focused/skipped tests in staged changes:"
  echo "$FOCUSED" | sed 's/^/   /'
  echo "Remove .only/.skip before committing."
  exit 1
fi

echo "âœ… Pre-commit passed."
