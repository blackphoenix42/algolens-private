#!/bin/sh
set -e

# --- settings -------------------------------------------------
: "${SKIP_PREPUSH_BUILD:=0}"   # set to 1 to skip build locally
: "${SKIP_PREPUSH_DEPS:=0}"    # set to 1 to skip dependency checks locally
# --------------------------------------------------------------

echo "ðŸš€ husky(pre-push): running comprehensive checksâ€¦"

# ensure repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "â†’ Typecheck"
npm run -s typecheck

echo "â†’ Lint & CSS checks"
if npm run -s lint:all >/dev/null 2>&1; then
  npm run -s lint:all
else
  echo "  (no 'lint:all' script; falling back to lint)"
  npm run -s lint
fi

echo "â†’ Format check"
if npm run -s format:check >/dev/null 2>&1; then
  npm run -s format:check
else
  echo "  (no 'format:check' script; skipping)"
fi

if [ "$SKIP_PREPUSH_DEPS" -eq 0 ]; then
  echo "â†’ Dependency checks"
  if npm run -s deps:unused >/dev/null 2>&1; then
    npm run -s deps:unused
  else
    echo "  (no 'deps:unused' script; skipping)"
  fi

  echo "â†’ License check"
  if npm run -s licenses:check >/dev/null 2>&1; then
    npm run -s licenses:check
  else
    echo "  (no 'licenses:check' script; skipping)"
  fi
else
  echo "â†’ Dependency checks skipped (SKIP_PREPUSH_DEPS=1)"
fi

echo "â†’ Tests"
if npm run -s test >/dev/null 2>&1; then
  npm run -s test
else
  echo "  (no 'test' script; skipping)"
fi

if [ "$SKIP_PREPUSH_BUILD" -eq 0 ]; then
  echo "â†’ Build (sanity)"
  if npm run -s build >/dev/null 2>&1; then
    npm run -s build
  else
    echo "  (no 'build' script; skipping)"
  fi
else
  echo "â†’ Build skipped (SKIP_PREPUSH_BUILD=1)"
fi

echo "âœ… All pre-push checks passed! Ready to push."
